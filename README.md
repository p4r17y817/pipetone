# Pipetone 🧵

🚀 A fast, Rusty port of `threadTone.py`

🌟 Full credit goes to [@theveloped](https://github.com/theveloped) for inspiring this implementation: check out their work [here](https://github.com/theveloped/ThreadTone)!

This binary crate "threads" images onto a virtual circular loom with evenly spaced pins. The user can control how many pins are on the loom and the maximum number of thread traversals to perform.

A run of this program performs the following steps:

1. The target image is pre-processed (cropped, grayscaled, inverted and masked).
1. Starting at pin `0`, the threading algorithm:
   1. Records the "fittest" pin (sum of luminance across the thread between the old pin and the new one).
	1. Repeats 2.1 with the best pin as the old pin until the max # threads are reached or the best pin is the old pin.
1. The threaded image (and desired CSV data) is generated and saved to the target directory.

Feedback and PRs are encouraged!

## 🛠️ Usage

### Example

This assumes the latest version of [`cargo`](https://doc.rust-lang.org/cargo/getting-started/installation.html) is installed.

```bash
❯ cargo run --release thread_me.png
```

This runs pipetone in release mode (see [Performance](#performance) and [Notes](#notes)) on `thread_me.png` (leaving it unaltered) and conjures its "threaded" twin at `./threaded.png`.

### Options

Pipetone threads circular half-tone images using a number of options:

Short Option | Long Option | Default | Description
-|-|-|-
`-p`|`--pins`|500|Number of pins on the circular loom
`-t`|`--threads`|1000|Maximum number of threads used
`-r`|`--radius`|min(height, width)|Radius of output image in pixels. If greater than default, clamped to default.
`-o`|`--output`|input's directory|Path to output image

So the following command is equivalent to the example command above:

```bash
❯ cargo run --release thread_me.png --pins 500 -t 1000 -o thread_me_500_1000_threaded.png
```

### Flags

Along with these options are flags for controlling output (all default to unset):

Flag | Default? | Description
-|-|-
`--csv`|❌|Save start and end coordinates of threads to CSV
`--header`|❌|Include CSV header line: `x1, y1, x2, y2`. Used with `--csv`
`--no-img`|❌|Skip image generation. Used with `--csv`
`--write-coords`|❌|Write thread end-point pixel coordinates instead of pin numbers to CSV. Used with `--csv`

Images are generated by default; CSVs aren't.

Let's say instead of generating an image, we want to generate a CSV with a header line that describes the pixel coordinates of each thread's start and end points:

```bash
❯ cargo run --release thread_me.png --csv --header --no-img --write-coords
```

## Output

Image and CSV output are saved in the same location (the same directory as the input image by default).

The default prefixing scheme is `<FILE STEM>_<# PINS>_<# THREADS>`, e.g.:

- `face.jpg` was passed with `-p 500 -t 1000`
- `face_500_1000_threaded.png` is the output image
- `face_500_1000_threads.csv` for CSVs

The contents of a generated `*.csv` file will look similar to the following.

- Default:

```csv
pins // Included if `--header` set
204
476
199
478
205
...
```

- With `--thread-coords` set:

```csv
x1,y1,x2,y2 // Included if `--header` set
2160,1080,206,1714
206,1714,2117,778
2117,778,168,1658
168,1658,2057,1539
2057,1539,150,1629
...
```


## 🖼️ Results

A cherry-picked handful:

House (p=1000, l=2000)|Trump (p=1000, l=2000)|Obama (p=1000, l=5000)|Putin (p=1000, l=2000)|Boris (p=1000, l=5000)
-|-|-|-|-
<img src="./images/house_1000_2000.png" width="135">|<img src="./images/trump_1000_2000.png" width="135">|<img src="./images/obama_1000_5000.png" width="135">|<img src="./images/putin_1000_2000.png" width="135">|<img src="./images/boris_1000_5000.png" width="135">

The patterns observed in the upper-rightmost corner of each table seem to occur when the thread can no longer fill any more of the image productively, but is able to find a sequence of pins that prevent the algorithm from halting early.

### Dr. Gregory House, M.D.

<img src="./images/house.jpg" width="150">

`pins/lines` | 500 | 1000 | 2000 | 5000
-|-|-|-|-
100|<img src="./images/house_100_500.png" width="135">|<img src="./images/house_100_1000.png" width="135">|<img src="./images/house_100_2000.png" width="135">|<img src="./images/house_100_5000.png" width="135">
200|<img src="./images/house_200_500.png" width="135">|<img src="./images/house_200_1000.png" width="135">|<img src="./images/house_200_2000.png" width="135">|<img src="./images/house_200_5000.png" width="135">
500|<img src="./images/house_500_500.png" width="135">|<img src="./images/house_500_1000.png" width="135">|<img src="./images/house_500_2000.png" width="135">|<img src="./images/house_500_5000.png" width="135">
1000|<img src="./images/house_1000_500.png" width="135">|<img src="./images/house_1000_1000.png" width="135">|<img src="./images/house_1000_2000.png" width="135">|<img src="./images/house_1000_5000.png" width="135">

### Donald Trump

<img src="./images/trump.jpg" width="150">

`pins/lines` | 500 | 1000 | 2000 | 5000
-|-|-|-|-
100|<img src="./images/trump_100_500.png" width="135">|<img src="./images/trump_100_1000.png" width="135">|<img src="./images/trump_100_2000.png" width="135">|<img src="./images/trump_100_5000.png" width="135">
200|<img src="./images/trump_200_500.png" width="135">|<img src="./images/trump_200_1000.png" width="135">|<img src="./images/trump_200_2000.png" width="135">|<img src="./images/trump_200_5000.png" width="135">
500|<img src="./images/trump_500_500.png" width="135">|<img src="./images/trump_500_1000.png" width="135">|<img src="./images/trump_500_2000.png" width="135">|<img src="./images/trump_500_5000.png" width="135">
1000|<img src="./images/trump_1000_500.png" width="135">|<img src="./images/trump_1000_1000.png" width="135">|<img src="./images/trump_1000_2000.png" width="135">|<img src="./images/trump_1000_5000.png" width="135">

### Barack Obama

<img src="./images/obama.jpg" width="150">

`pins/lines` | 500 | 1000 | 2000 | 5000
-|-|-|-|-
100|<img src="./images/obama_100_500.png" width="135">|<img src="./images/obama_100_1000.png" width="135">|<img src="./images/obama_100_2000.png" width="135">|<img src="./images/obama_100_5000.png" width="135">
200|<img src="./images/obama_200_500.png" width="135">|<img src="./images/obama_200_1000.png" width="135">|<img src="./images/obama_200_2000.png" width="135">|<img src="./images/obama_200_5000.png" width="135">
500|<img src="./images/obama_500_500.png" width="135">|<img src="./images/obama_500_1000.png" width="135">|<img src="./images/obama_500_2000.png" width="135">|<img src="./images/obama_500_5000.png" width="135">
1000|<img src="./images/obama_1000_500.png" width="135">|<img src="./images/obama_1000_1000.png" width="135">|<img src="./images/obama_1000_2000.png" width="135">|<img src="./images/obama_1000_5000.png" width="135">

### Vladimir Putin

<img src="./images/putin.jpg" width="150">

`pins/lines` | 500 | 1000 | 2000 | 5000
-|-|-|-|-
100|<img src="./images/putin_100_500.png" width="135">|<img src="./images/putin_100_1000.png" width="135">|<img src="./images/putin_100_2000.png" width="135">|<img src="./images/putin_100_5000.png" width="135">
200|<img src="./images/putin_200_500.png" width="135">|<img src="./images/putin_200_1000.png" width="135">|<img src="./images/putin_200_2000.png" width="135">|<img src="./images/putin_200_5000.png" width="135">
500|<img src="./images/putin_500_500.png" width="135">|<img src="./images/putin_500_1000.png" width="135">|<img src="./images/putin_500_2000.png" width="135">|<img src="./images/putin_500_5000.png" width="135">
1000|<img src="./images/putin_1000_500.png" width="135">|<img src="./images/putin_1000_1000.png" width="135">|<img src="./images/putin_1000_2000.png" width="135">|<img src="./images/putin_1000_5000.png" width="135">

### Boris Johnson

<img src="./images/boris.jpg" width="150">

`pins/lines` | 500 | 1000 | 2000 | 5000
-|-|-|-|-
100|<img src="./images/boris_100_500.png" width="135">|<img src="./images/boris_100_1000.png" width="135">|<img src="./images/boris_100_2000.png" width="135">|<img src="./images/boris_100_5000.png" width="135">
200|<img src="./images/boris_200_500.png" width="135">|<img src="./images/boris_200_1000.png" width="135">|<img src="./images/boris_200_2000.png" width="135">|<img src="./images/boris_200_5000.png" width="135">
500|<img src="./images/boris_500_500.png" width="135">|<img src="./images/boris_500_1000.png" width="135">|<img src="./images/boris_500_2000.png" width="135">|<img src="./images/boris_500_5000.png" width="135">
1000|<img src="./images/boris_1000_500.png" width="135">|<img src="./images/boris_1000_1000.png" width="135">|<img src="./images/boris_1000_2000.png" width="135">|<img src="./images/boris_1000_5000.png" width="135">

## 🚀 Performance

Rough measurement using the `time` utility yields the following execution times. The same 1920x1080 image and parameters (`threadTone.py`'s defaults) were used:

### pipetone

```bash
❯ hyperfine --warmup 3 'target/release/pipetone images/house.jpg -p 200 -r 500'
Benchmark #1: target/release/pipetone images/house.jpg -p 200 -r 500
  Time (mean ± σ):     997.9 ms ±  14.6 ms    [User: 994.5 ms, System: 95.5 ms]
  Range (min … max):   978.3 ms … 1023.3 ms    10 runs
```

### Threadtone

```bash
❯ hyperfine --warmup 3 'python3 threadTone.py images/house.jpg'
Benchmark #1: python3 threadTone.py images/house.jpg
  Time (mean ± σ):     21.941 s ±  0.513 s    [User: 22.322 s, System: 0.957 s]
  Range (min … max):   21.522 s … 23.110 s    10 runs
```

### Debug Mode: A Cautionary Tale...

```bash
❯ hyperfine --warmup 3 'target/debug/pipetone images/house.jpg -p 200 -r 500'
Benchmark #1: target/debug/pipetone images/house.jpg -p 200 -r 500
  Time (mean ± σ):     52.381 s ±  3.390 s    [User: 54.234 s, System: 0.088 s]
  Range (min … max):   48.479 s … 59.454 s    10 runs
```

## Notes

- Running in `--release` mode is recommended as the `image` crate taxes debug mode builds fairly aggressively.

## See Also

- [@thevelop](https://github.com/theveloped)'s excellent [blog post](http://www.thevelop.nl/blog/2016-12-25/ThreadTone/)
- [@danielvarga](https://github.com/danielvarga)'s [string-art](https://github.com/danielvarga/string-art) solves the same task in another interesting way.
